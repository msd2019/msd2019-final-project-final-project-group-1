---
title: 'MSD 2019 Final Project'
subtitle: 'A replication and extension of Wage disparity and team productivity: evidence from Major League Baseball by Craig A. Depken II, 1999'
author: 'Forrest Hofmann (fhh2112) & Sagar Lal (sl3946)'
date: '`r Sys.time()`'
output:
  pdf_document:
    toc: yes
    toc_depth: 3
---

```{r setup, include=FALSE}
library(here)
library(scales)
library(tidyverse)
library(ineq)

theme_set(theme_bw())

knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

## Problem Description

## Motivation

## Data Source


# Reproduction

## Reproduction Code

```{r load-data, message = FALSE}
teams <- read_csv(here('data/teams.csv'))
salaries <- read_csv(here('data/salaries.csv'))
```

```{r clean-data, message = FALSE}
teams$WSWin <- as.logical(teams$WSWin == 'Y')
teams <- teams %>%
  filter(1985 <= yearID & yearID <= 2016) %>%
  mutate(winPercentage = W / (W + L) * 1000) %>%
    filter(yearID != 1987) %>% 
    filter(teamID != 'TEX')

salaries <- salaries %>%
  filter(1985 <= yearID & yearID <= 2016) %>%
  mutate(salaryMil = salary / 1000000) %>%
  filter(yearID != 1987) %>% 
    filter(teamID != 'TEX')
```

```{r compute-team-salary-total, message = FALSE}
teams <- teams %>%
  inner_join(salaries) %>%
  group_by(yearID, teamID, G, W, L, WSWin, winPercentage) %>%
  summarize(totalSalaryMil = sum(salaryMil))
```

```{r compute-player-salary-share, message = FALSE}
salaries <- salaries %>% 
  inner_join(teams) %>%
  mutate(salaryShare = salaryMil / totalSalaryMil * 100) %>%
  mutate(salaryShareSquared = salaryShare ^ 2) %>%
  select(yearID, teamID, playerID, salary, salaryShare, salaryShareSquared)

#Clearly missing lots of data for this datapoint https://www.baseball-reference.com/teams/TEX/1987.shtml
# rangers_1987 <- salaries %>%
#   filter(yearID == 1987) %>% 
#     filter(teamID == 'TEX')

```

```{r compute-team-salary-hhi, message = FALSE}
teams <- teams %>%
  inner_join(salaries) %>%
  group_by(yearID, teamID, G, W, L, winPercentage, WSWin, totalSalaryMil) %>%
  summarize(HHI = sum(salaryShareSquared))
```

```{r subset-old-data, message = FALSE}
teams_old <- teams %>%
  filter(1985 <= yearID & yearID <= 1998) %>%
  mutate(normalizedYear = yearID - 1985)

salaries_old <- salaries %>%
  filter(1985 <= yearID & yearID <= 1998)
```

```{r summary-statistics}
summary(teams_old$winPercentage)
sd(teams_old$winPercentage)
summary(teams_old$totalSalaryMil)
sd(teams_old$totalSalaryMil)
summary(teams_old$HHI)
sd(teams_old$HHI)
```

```{r linear-fixed-effects-regression-old}
linear_fixed_old <- lm(formula = winPercentage ~ totalSalaryMil + HHI +
                                                 normalizedYear + teamID + 0,
                       data = teams_old)
summary(linear_fixed_old)$coefficients[1:3,]
```

```{r linear-random-effects-regression-old}
linear_random_old <- lm(formula = winPercentage ~ totalSalaryMil + HHI + normalizedYear,
                        data = teams_old)
summary(linear_random_old)$coefficients[1:4,]
```

# ```{r log-log-fixed-effects-regression-old}
# log_log_fixed_old <- lm(formula = log(winPercentage) ~ log(totalSalaryMil) + log(HHI) +
#                                                        normalizedYear + teamID + 0,
#                         data = teams_old)
# summary(log_log_fixed_old)$coefficients[1:3,]
# ```

# ```{r log-log-random-effects-regression-old}
# log_log_random_old <- lm(formula = log(winPercentage) ~ log(totalSalaryMil) + log(HHI) +
#                                                         normalizedYear,
#                          data = teams_old)
# summary(log_log_random_old)$coefficients[1:4,]
# ```

## Reproduction Notes

- original author did not describe how time fixed effects are accounted for (across expansion periods or every year)
- no discussion about limiting to 25 man roster vs 40 man roster
- no discussion of cut players, traded players
- no discussion of signing bonuses

## Reproduction Analysis


# Extension

## Extension Code

```{r salary-vs-time, message = FALSE, out.width = '70%', fig.align = 'center'}
salary_vs_time <- salaries %>%
  group_by(yearID) %>%
  summarize(avg = mean(salary), max = max(salary))

ggplot(data = salary_vs_time) +
  geom_point(aes(x = yearID, y = avg, color = 'Average')) +
  geom_smooth(aes(x = yearID, y = avg, color = 'Average')) + 
  geom_point(aes(x = yearID, y = max, color = 'Maximum')) + 
  geom_smooth(aes(x = yearID, y = max, color = 'Maximum')) +
  scale_color_manual(values = c('#4286f4', '#f44741')) +
  scale_y_log10(labels = comma) + 
  labs(color = 'Type') +
  xlab('Year') +
  ylab('Player Salary')
```

```{r player-salary-distributions, message = FALSE, out.width = '55%', fig.align = 'center'}
salaries_1985 <- filter(salaries, yearID == 1985)
salaries_1998 <- filter(salaries, yearID == 1998)
salaries_2016 <- filter(salaries, yearID == 2016)

ggplot(data = salaries_1985) +
  geom_histogram(aes(x = salary, y = (..count..) / sum(..count..))) +
  scale_x_continuous(labels = comma) + 
  xlab('Player Salary in 1985') +
  ylab('Fraction of All Salaries in 1985')

ggplot(data = salaries_1998) +
  geom_histogram(aes(x = salary, y = (..count..) / sum(..count..))) +
  scale_x_continuous(labels = comma) + 
  xlab('Player Salary in 1998') +
  ylab('Fraction of All Salaries in 1998')

ggplot(data = salaries_2016) +
  geom_histogram(aes(x = salary, y = (..count..) / sum(..count..))) +
  scale_x_continuous(labels = comma) + 
  xlab('Player Salary in 2016') +
  ylab('Fraction of All Salaries in 2016')
```

```{r team-salary-vs-time, message = FALSE, out.width = '80%', fig.align = 'center'}
current_teamIDs <- c('ARI', 'ATL', 'BAL', 'BOS', 'CHA', 'CHN', 'CIN', 'CLE', 'COL', 'DET',
                     'HOU', 'KCA', 'LAA', 'LAN', 'MIA', 'MIL', 'MIN', 'NYA', 'NYN', 'OAK',
                     'PHI', 'PIT', 'SDN', 'SEA', 'SFN', 'SLN', 'TBA', 'TEX', 'TOR', 'WAS')
team_colors <- c('#cccccc', '#cccccc', '#cccccc', '#BD3039', '#cccccc',
                 '#cccccc', '#cccccc', '#cccccc', '#cccccc', '#cccccc',
                 '#cccccc', '#cccccc', '#cccccc', '#0157a8', '#cccccc',
                 '#cccccc', '#cccccc', '#11325b', '#cccccc', '#04683b',
                 '#cccccc', '#cccccc', '#cccccc', '#cccccc', '#cccccc',
                 '#cccccc', '#cccccc', '#cccccc', '#cccccc', '#cccccc')
colored_teamIDs <- c('BOS', 'LAN', 'NYA', 'OAK')

team_salary_vs_time <- salaries %>%
  filter(teamID %in% current_teamIDs) %>%
  group_by(yearID, teamID) %>%
  summarize(avg = mean(salary)) %>%
  mutate(flag = teamID %in% colored_teamIDs)

underlay_data <- filter(team_salary_vs_time, !flag)
overlay_data <- filter(team_salary_vs_time, flag)

ggplot() +
  geom_point(data = underlay_data, aes(x = yearID, y = avg, color = teamID)) +
  geom_line(data = underlay_data, aes(x = yearID, y = avg, color = teamID)) +
  geom_point(data = overlay_data, aes(x = yearID, y = avg, color = teamID)) +
  geom_line(data = overlay_data, aes(x = yearID, y = avg, color = teamID)) +
  scale_y_continuous(labels = comma) + 
  scale_color_manual(values = team_colors) +
  labs(color = 'Team') +
  xlab('Year') +
  ylab('Average Team Salary')
```

```{r hhi-vs-time, message = FALSE, out.width = '70%', fig.align = 'center'}
hhi_vs_time <- teams %>%
  group_by(yearID) %>%
  summarize(avg = mean(HHI))

ggplot(data = hhi_vs_time) +
  geom_point(aes(x = yearID, y = avg)) +
  geom_smooth(aes(x = yearID, y = avg)) + 
  xlab('Year') +
  ylab('Average Team HHI')
```

```{r hhi-distributions, message = FALSE, out.width = '55%', fig.align = 'center'}
ggplot(data = filter(teams, mean(teams$HHI) - 5 * sd(teams$HHI) <= HHI & HHI <= mean(teams$HHI) + 5 * sd(teams$HHI))) +
  geom_histogram(aes(x = HHI, y = (..count..) / sum(..count..))) +
  geom_vline(data = filter(teams, WSWin), aes(xintercept = HHI), color = 'blue', linetype = 'dashed') +
  xlab('Team HHI') +
  ylab('Fraction of All HHI Values')
```

```{r hhi-vs-total-salary, message = FALSE, out.width = '70%', fig.align = 'center'}
year_to_period <- function(year) {
  if (year <= 1992) {
    return('Pre 1993')
  }
  else if (1993 <= year & year <= 1997) {
    return('Between 1993 and 1997')
  }
  else {
    return('Post 1997')
  }
}

hhi_vs_total_salary <- teams %>%
  mutate(period = year_to_period(yearID))
hhi_vs_total_salary$period <- factor(hhi_vs_total_salary$period, levels = c('Pre 1993', 'Between 1993 and 1997', 'Post 1997'))

ggplot(data = hhi_vs_total_salary) +
  geom_point(aes(x = totalSalaryMil * 1000000, y = HHI, color = period)) +
  scale_x_log10(labels = comma) +
  scale_y_log10() +
  labs(color = 'Period') +
  xlab('Total Team Salary') +
  ylab('Team HHI')
```

```{r subset-new-data, message = FALSE}
teams_new <- teams %>%
  filter(1999 <= yearID & yearID <= 2016) %>%
  mutate(normalizedYear = yearID - 1999)

salaries_new <- salaries %>%
  filter(1999 <= yearID & yearID <= 2016)
```

```{r linear-fixed-effects-regression-new}
linear_fixed_new <- lm(formula = winPercentage ~ totalSalaryMil + HHI +
                                                 normalizedYear + teamID + 0,
                       data = teams_new)
summary(linear_fixed_new)$coefficients[1:3,]
```

```{r linear-random-effects-regression-new}
linear_random_new <- lm(formula = winPercentage ~ totalSalaryMil + HHI + normalizedYear,
                        data = teams_new)
summary(linear_random_new)$coefficients[1:4,]
```

```{r log-log-fixed-effects-regression-new}
log_log_fixed_new <- lm(formula = log(winPercentage) ~ log(totalSalaryMil) + log(HHI) +
                                                       normalizedYear + teamID + 0,
                        data = teams_new)
summary(log_log_fixed_new)$coefficients[1:3,]
```

```{r log-log-random-effects-regression-new}
log_log_random_new <- lm(formula = log(winPercentage) ~ log(totalSalaryMil) + log(HHI) +
                                                        normalizedYear,
                         data = teams_new)
summary(log_log_random_new)$coefficients[1:4,]
```

```{r compute new inequality index- gini- and run regressions}
#Gini coef: https://en.wikipedia.org/wiki/Gini_coefficient

gini_coef <- salaries %>%
  group_by(yearID, teamID) %>%
    summarize(gini_coef = Gini(salary))

teams <- teams %>%
  inner_join(gini_coef)

#Compare Gini index to HHI for old teams
gini_old <- teams %>%
  filter(1985 <= yearID & yearID <= 1998) %>%
  mutate(normalizedYear = yearID - 1985)

gini_fixed_old <- lm(formula = winPercentage ~ totalSalaryMil + gini_coef +
                                                 normalizedYear + teamID + 0,
                       data = gini_old)
summary(linear_fixed_old)$coefficients[1:3,]
summary(gini_fixed_old)$coefficients[1:3,]

gini_random_old <- lm(formula = winPercentage ~ totalSalaryMil + gini_coef + normalizedYear,
                        data = gini_old)
summary(linear_random_old)$coefficients[1:4,]
summary(gini_random_old)$coefficients[1:4,]


#Compare Gini coef to HHI results for new teams
gini_new <- teams %>%
  filter(1999 <= yearID & yearID <= 2016) %>%
  mutate(normalizedYear = yearID - 1999)

gini_fixed_new <- lm(formula = winPercentage ~ totalSalaryMil + gini_coef +
                                                 normalizedYear + teamID + 0,
                       data = gini_new)
summary(linear_fixed_new)$coefficients[1:3,]
summary(gini_fixed_new)$coefficients[1:3,]

gini_random_new <- lm(formula = winPercentage ~ totalSalaryMil + gini_coef + normalizedYear,
                        data = gini_new)
summary(linear_random_new)$coefficients[1:4,]
summary(gini_random_new)$coefficients[1:4,]
```
```{r compute new inequality index- Atkinson index- and run regressions}
#Atkinson index: https://en.wikipedia.org/wiki/Atkinson_index

atkinson <- salaries %>%
  group_by(yearID, teamID) %>%
    summarize(atk = Atkinson(salary))

teams <- teams %>%
  inner_join(atkinson)

#Compare Atkinson index to HHI for old teams
atk_old <- teams %>%
  filter(1985 <= yearID & yearID <= 1998) %>%
  mutate(normalizedYear = yearID - 1985)

atk_fixed_old <- lm(formula = winPercentage ~ totalSalaryMil + atk +
                                                 normalizedYear + teamID + 0,
                       data = atk_old)
summary(linear_fixed_old)$coefficients[1:3,]
summary(atk_fixed_old)$coefficients[1:3,]

atk_random_old <- lm(formula = winPercentage ~ totalSalaryMil + atk + normalizedYear,
                        data = atk_old)
summary(linear_random_old)$coefficients[1:4,]
summary(atk_random_old)$coefficients[1:4,]


#Compare Atkinson coef to HHI results for new teams
atk_new <- teams %>%
  filter(1999 <= yearID & yearID <= 2016) %>%
  mutate(normalizedYear = yearID - 1999)

atk_fixed_new <- lm(formula = winPercentage ~ totalSalaryMil + atk +
                                                 normalizedYear + teamID + 0,
                       data = atk_new)
summary(linear_fixed_new)$coefficients[1:3,]
summary(atk_fixed_new)$coefficients[1:3,]

atk_random_new <- lm(formula = winPercentage ~ totalSalaryMil + atk + normalizedYear,
                        data = atk_new)
summary(linear_random_new)$coefficients[1:4,]
summary(atk_random_new)$coefficients[1:4,]
```
```{r try predicting with models}
teams <- teams %>%
  mutate(normalizedYear = yearID - 1985)

set.seed(42)
num_folds <- 5
num_rows <- nrow(teams)

ndx <- sample(1:num_rows, num_rows, replace=F)

train_data <- teams[ndx, ] %>%
  mutate(fold = (row_number() %% num_folds) + 1)

#head(train_data)
#BUGtemp_train <- train_data %>% group_by(fold) %>% summarize(count = n())

# do 5-fold cross-validation
validate_err <- c()
train_err <- c()

for (f in 1:num_folds) {
  # fit on the training data
  temp_train <- filter(train_data, fold != f)
  model <- lm(formula = winPercentage ~ totalSalaryMil + HHI +
                                                 normalizedYear + teamID + 0,
                       data = temp_train)
  
  train_err[f] <- sqrt(mean( (predict (model, temp_train) - temp_train$winPercentage) ^2) )
  
  
  # evaluate on the validation data
  temp_validate <- filter(train_data, fold == f)
  validate_err[f] <- sqrt(mean( (predict (model, temp_validate) - temp_validate$winPercentage) ^2) )
}

# compute the average validation error across folds
# and the standard error on this estimate
avg_validate_err <- mean(validate_err)
se_validate_err <- sd(validate_err) / sqrt(num_folds)

avg_train_err <- mean(train_err)
se_train_err <- sd(train_err) / sqrt(num_folds)
  


```

## Extension Notes

- note that minimum salary has increased over time: https://www.baseball-reference.com/bullpen/Minimum_salary

## Extension Analysis

# Postface

The following is a list of all packages used to generate these results.

```{r}
sessionInfo()
```