---
title: 'MSD Final Project Report'
author: 'Forrest Hofmann (fhh2112) & Sagar Lal (sl3946)'
date: '`r Sys.time()`'
output:
  pdf_document:
    toc: yes
    toc_depth: 3
---

```{r setup, include=FALSE}
library(here)
library(tidyverse)
library(scales)

theme_set(theme_bw())

knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

## Problem Description

## Motivation

## Data Source


# Reproduction

## Reproduction Code

```{r load-data}
teams <- read_csv(here('teams.csv'))
salaries <- read_csv(here('salaries.csv'))
```

```{r clean-data}
teams <- teams %>%
  filter(1985 <= yearID & yearID <= 2016) %>%
  mutate(winPercentage = W / (W + L) * 1000)

salaries <- salaries %>%
  filter(1985 <= yearID & yearID <= 2016) %>%
  mutate(salaryMil = salary / 1000000)
```

```{r compute-team-salary-total}
teams <- teams %>%
  inner_join(salaries) %>%
  group_by(yearID, teamID, G, W, L, winPercentage) %>%
  summarize(totalSalaryMil = sum(salaryMil))
```

```{r compute-player-salary-share}
salaries <- salaries %>% 
  inner_join(teams) %>%
  mutate(salaryShare = salaryMil / totalSalaryMil * 100) %>%
  mutate(salaryShareSquared = salaryShare ^ 2) %>%
  select(yearID, teamID, playerID, salary, salaryShare, salaryShareSquared)
```

```{r compute-team-salary-hhi}
teams <- teams %>%
  inner_join(salaries) %>%
  group_by(yearID, teamID, G, W, L, winPercentage, totalSalaryMil) %>%
  summarize(HHI = sum(salaryShareSquared))
```

```{r subset-old-data}
teams_old <- teams %>%
  filter(1985 <= yearID & yearID <= 1998) %>%
  mutate(normalizedYear = yearID - 1985)

salaries_old <- salaries %>%
  filter(1985 <= yearID & yearID <= 1998)
```

```{r summary-statistics}
summary(teams_old$winPercentage)
summary(teams_old$totalSalaryMil)
summary(teams_old$HHI)
```

```{r linear-fixed-effects-regression-old}
linear_fixed_old <- lm(formula = winPercentage ~ totalSalaryMil + HHI + normalizedYear + teamID + 0,
                       data = teams_old)
summary(linear_fixed_old)$coefficients
```

```{r linear-random-effects-regression-old}
linear_random_old <- lm(formula = winPercentage ~ totalSalaryMil + HHI + normalizedYear,
                        data = teams_old)
summary(linear_random_old)$coefficients
```

```{r log-log-fixed-effects-regression-old}
log_log_fixed_old <- lm(formula = log(winPercentage) ~ log(totalSalaryMil) + log(HHI) + normalizedYear + teamID + 0,
                        data = teams_old)
summary(log_log_fixed_old)$coefficients
```

```{r log-log-random-effects-regression-old}
log_log_random_old <- lm(formula = log(winPercentage) ~ log(totalSalaryMil) + log(HHI) + normalizedYear,
                         data = teams_old)
summary(log_log_random_old)$coefficients
```

## Reproduction Notes

- original author did not describe how time fixed effects are accounted for (across expansion periods or every year)
- no discussion about limiting to 25 man roster vs 40 man roster
- no discussion of cut players, traded players
- no discussion of signing bonuses

## Reproduction Analysis


# Extension

## Extension Code

```{r salary-vs-time}
salary_vs_time <- salaries %>%
  group_by(yearID) %>%
  summarize(avg = mean(salary), max = max(salary))

ggplot(data = salary_vs_time) +
  geom_point(aes(x = yearID, y = avg, color = 'Average')) +
  geom_smooth(aes(x = yearID, y = avg, color = 'Average')) + 
  geom_point(aes(x = yearID, y = max, color = 'Maximum')) + 
  geom_smooth(aes(x = yearID, y = max, color = 'Maximum')) +
  scale_color_manual(values = c('#4286f4', '#f44741')) +
  scale_y_continuous(labels = comma) + 
  labs(color = 'Type') +
  xlab('Year') +
  ylab('Player Salary')
```

```{r player-salary-distributions}
salaries_1985 <- filter(salaries, yearID == 1985)
salaries_1998 <- filter(salaries, yearID == 1998)
salaries_2016 <- filter(salaries, yearID == 2016)

ggplot(data = salaries_1985) +
  geom_histogram(aes(x = salary, y = (..count..)/sum(..count..))) +
  xlab('Player Salary') +
  ylab('Percentage of All Salaries')

ggplot(data = salaries_1998) +
  geom_histogram(aes(x = salary, y = (..count..)/sum(..count..))) +
  xlab('Player Salary') +
  ylab('Percentage of All Salaries')

ggplot(data = salaries_2016) +
  geom_histogram(aes(x = salary, y = (..count..)/sum(..count..))) +
  xlab('Player Salary') +
  ylab('Percentage of All Salaries')
```

```{r team-salary-vs-time}
current_teamIDs <- c('ARI', 'ATL', 'BAL', 'BOS', 'CHA', 'CHN', 'CIN', 'CLE', 'COL', 'DET',
                     'HOU', 'KCA', 'LAA', 'LAN', 'MIA', 'MIL', 'MIN', 'NYA', 'NYN', 'OAK',
                     'PHI', 'PIT', 'SDN', 'SEA', 'SFN', 'SLN', 'TBA', 'TEX', 'TOR', 'WAS')
team_colors <- c('#cccccc', '#cccccc', '#cccccc', '#BD3039', '#cccccc',
                 '#cccccc', '#cccccc', '#cccccc', '#cccccc', '#cccccc',
                 '#cccccc', '#cccccc', '#cccccc', '#0157a8', '#cccccc',
                 '#cccccc', '#cccccc', '#11325b', '#cccccc', '#04683b',
                 '#cccccc', '#cccccc', '#cccccc', '#cccccc', '#cccccc',
                 '#cccccc', '#cccccc', '#cccccc', '#cccccc', '#cccccc')
colored_teamIDs <- c('BOS', 'LAN', 'NYA', 'OAK')

team_salary_vs_time <- salaries %>%
  filter(teamID %in% current_teamIDs) %>%
  group_by(yearID, teamID) %>%
  summarize(avg = mean(salary)) %>%
  mutate(flag = teamID %in% colored_teamIDs)

underlay_data <- filter(team_salary_vs_time, !flag)
overlay_data <- filter(team_salary_vs_time, flag)

ggplot() +
  geom_point(data = underlay_data, aes(x = yearID, y = avg, color = teamID)) +
  geom_line(data = underlay_data, aes(x = yearID, y = avg, color = teamID)) +
  geom_point(data = overlay_data, aes(x = yearID, y = avg, color = teamID)) +
  geom_line(data = overlay_data, aes(x = yearID, y = avg, color = teamID)) +
  scale_y_continuous(labels = comma) + 
  scale_color_manual(values = team_colors) +
  labs(color = 'Team') +
  xlab('Year') +
  ylab('Average Team Salary')
```

```{r hhi-vs-time}
hhi_vs_time <- teams %>%
  group_by(yearID) %>%
  summarize(avg = mean(HHI))

ggplot(data = hhi_vs_time) +
  geom_point(aes(x = yearID, y = avg)) +
  geom_smooth(aes(x = yearID, y = avg)) + 
  xlab('Year') +
  ylab('Average Intrateam HHI')
```

```{r hhi-vs-total-salary}
year_to_period <- function(year) {
  if (year <= 1992) {
    return('Pre 1993')
  }
  else if (1993 <= year & year <= 1997) {
    return('Between 1993 and 1997')
  }
  else {
    return('Post 1997')
  }
}

hhi_vs_total_salary <- teams %>%
  mutate(period = year_to_period(yearID))

ggplot(data = hhi_vs_total_salary) +
  geom_point(aes(x = totalSalaryMil * 1000000, y = HHI, color = period)) +
  scale_x_log10(labels = comma) +
  scale_y_log10() +
  xlab('Total Team Salary') +
  ylab('Team HHI')
```

```{r subset-new-data}
teams_old <- teams %>%
  filter(1999 <= yearID & yearID <= 2016) %>%
  mutate(normalizedYear = yearID - 1999)

salaries_old <- salaries %>%
  filter(1999 <= yearID & yearID <= 2016)
```

```{r linear-fixed-effects-regression-new}
```

```{r linear-random-effects-regression-new}
```

```{r log-log-fixed-effects-regression-new}
```

```{r log-log-random-effects-regression-new}
```

## Extension Notes

- note that minimum salary has increased over time: https://www.baseball-reference.com/bullpen/Minimum_salary

## Extension Analysis