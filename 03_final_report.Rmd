---
title: 'MSD Final Project Report'
author: 'Forrest Hofmann (fhh2112) & Sagar Lal (sl3946)'
date: '`r Sys.time()`'
output:
  pdf_document:
    toc: yes
    toc_depth: 3
---

```{r setup, include=FALSE}
library(here)
library(tidyverse)
library(scales)

theme_set(theme_bw())

knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

## Problem Description

## Motivation

## Data Source


# Reproduction

## Reproduction Code

```{r load-data}
teams <- read_csv(here('teams.csv'))
salaries <- read_csv(here('salaries.csv'))
```

```{r clean-old-data}
teams_old <- teams %>%
  filter(1985 <= yearID & yearID <= 1998) %>%
  mutate(winPercentage = W / (W + L) * 1000) %>%
  mutate(normalizedYear = yearID - 1985)

salaries_old <- salaries %>%
  filter(1985 <= yearID & yearID <= 1998) %>%
  mutate(salaryMil = salary / 1000000)
```

```{r compute-team-salary-total}
teams_old <- teams_old %>%
  inner_join(salaries_old) %>%
  group_by(yearID, teamID, G, W, L, winPercentage, normalizedYear) %>%
  summarize(totalSalaryMil = sum(salaryMil))
```

```{r compute-player-salary-share}
salaries_old <- salaries_old %>% 
  inner_join(teams_old) %>%
  mutate(salaryShare = salaryMil / totalSalaryMil * 100) %>%
  mutate(salaryShareSquared = salaryShare ^ 2) %>%
  select(yearID, teamID, playerID, salary, salaryShare, salaryShareSquared)
```

```{r compute-team-salary-hhi}
teams_old <- teams_old %>%
  inner_join(salaries_old) %>%
  group_by(yearID, teamID, G, W, L, winPercentage, totalSalaryMil, normalizedYear) %>%
  summarize(HHI = sum(salaryShareSquared))
```

```{r summary-statistics}
summary(teams_old$winPercentage)
summary(teams_old$totalSalaryMil)
summary(teams_old$HHI)
```

```{r linear-fixed-effects-regression-old}
linear_fixed_old <- lm(formula = winPercentage ~ totalSalaryMil + HHI + normalizedYear + teamID + 0,
                       data = teams_old)
summary(linear_fixed_old)$coefficients
```

```{r linear-random-effects-regression-old}
linear_random_old <- lm(formula = winPercentage ~ totalSalaryMil + HHI + normalizedYear,
                        data = teams_old)
summary(linear_random_old)$coefficients
```

```{r log-log-fixed-effects-regression-old}
log_log_fixed_old <- lm(formula = log(winPercentage) ~ log(totalSalaryMil) + log(HHI) + normalizedYear + teamID + 0,
                        data = teams_old)
summary(log_log_fixed_old)$coefficients
```

```{r log-log-random-effects-regression-old}
log_log_random_old <- lm(formula = log(winPercentage) ~ log(totalSalaryMil) + log(HHI) + normalizedYear,
                         data = teams_old)
summary(log_log_random_old)$coefficients
```

## Reproduction Notes

- original author did not describe how time fixed effects are accounted for (across expansion periods or every year)
- no discussion about limiting to 25 man roster vs 40 man roster
- no discussion of cut players, traded players
- no discussion of signing bonuses

## Reproduction Analysis


# Extension

## Extension Code

```{r clean-new-data}
teams_new <- teams %>%
  filter(1999 <= yearID & yearID <= 2016) %>%
  mutate(winPercentage = W / (W + L) * 1000) %>%
  mutate(normalizedYear = yearID - 1985)

salaries_new <- salaries %>%
  filter(1999 <= yearID & yearID <= 2016) %>%
  mutate(salaryMil = salary / 1000000)
```

```{r salary-vs-time}
salary_vs_time <- salaries %>%
  group_by(yearID) %>%
  summarize(avg = mean(salary), max = max(salary))

ggplot(data = salary_vs_time) +
  geom_point(aes(x = yearID, y = avg, color = 'Average')) +
  geom_smooth(aes(x = yearID, y = avg, color = 'Average')) + 
  geom_point(aes(x = yearID, y = max, color = 'Maximum')) + 
  geom_smooth(aes(x = yearID, y = max, color = 'Maximum')) +
  scale_color_manual(values = c('#4286f4', '#f44741')) +
  scale_y_continuous(labels = comma) + 
  labs(color = 'Type') +
  xlab('Year') +
  ylab('Player Salary')
```

```{r team-salary-vs-time}
current_teamIDs <- c('ARI', 'ATL', 'BAL', 'BOS', 'CHA', 'CHN', 'CIN', 'CLE', 'COL', 'DET',
                     'HOU', 'KCA', 'LAA', 'LAN', 'MIA', 'MIL', 'MIN', 'NYA', 'NYN', 'OAK',
                     'PHI', 'PIT', 'SDN', 'SEA', 'SFN', 'SLN', 'TBA', 'TEX', 'TOR', 'WAS')
team_colors <- c('#cccccc', '#cccccc', '#cccccc', '#BD3039', '#cccccc',
                 '#cccccc', '#cccccc', '#cccccc', '#cccccc', '#cccccc',
                 '#cccccc', '#cccccc', '#cccccc', '#0157a8', '#cccccc',
                 '#cccccc', '#cccccc', '#11325b', '#cccccc', '#04683b',
                 '#cccccc', '#cccccc', '#cccccc', '#cccccc', '#cccccc',
                 '#cccccc', '#cccccc', '#cccccc', '#cccccc', '#cccccc')
colored_teamIDs <- c('BOS', 'LAN', 'NYA', 'OAK')

team_salary_vs_time <- salaries %>%
  filter(teamID %in% current_teamIDs) %>%
  group_by(yearID, teamID) %>%
  summarize(avg = mean(salary)) %>%
  mutate(flag = teamID %in% colored_teamIDs)

underlay_data <- filter(team_salary_vs_time, !flag)
overlay_data <- filter(team_salary_vs_time, flag)

ggplot() +
  geom_point(data = underlay_data, aes(x = yearID, y = avg, color = teamID)) +
  geom_line(data = underlay_data, aes(x = yearID, y = avg, color = teamID)) +
  geom_point(data = overlay_data, aes(x = yearID, y = avg, color = teamID)) +
  geom_line(data = overlay_data, aes(x = yearID, y = avg, color = teamID)) +
  scale_y_continuous(labels = comma) + 
  scale_color_manual(values = team_colors) +
  labs(color = 'Team') +
  xlab('Year') +
  ylab('Average Team Salary')
```

```{r hhi-vs-time}
```

```{r hhi-vs-salary}
```

```{r salary-distributions}
# TODO: plot distribution of win percentage, total salary, HHI
```

```{r hhi-distributions}
# TODO: plot distribution of win percentage, total salary, HHI
```

```{r linear-fixed-effects-regression-new}
```

```{r linear-random-effects-regression-new}
```

```{r log-log-fixed-effects-regression-new}
```

```{r log-log-random-effects-regression-new}
```

## Extension Notes

## Extension Analysis